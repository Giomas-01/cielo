<script>
    function calculateEphemeris() {
      const month = parseInt(document.getElementById('month').value);
      const year = parseInt(document.getElementById('year').value);
      const latitude = parseFloat(document.getElementById('latitude').value);
      const longitude = parseFloat(document.getElementById('longitude').value);
      const timezoneOffset = parseInt(document.getElementById('timezone').value);
      const height = 0;

      const daysInMonth = new Date(year, month, 0).getDate();
      const tableBody = document.querySelector('#resultsTable tbody');
      tableBody.innerHTML = '';

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(Date.UTC(year, month - 1, day));
        const jdo = new A.JulianDay(date);
        const observerCoord = A.GlobeCoord.fromWgs84(latitude, longitude, height);

        try {
          // Calcola i tempi per Mercurio
          const times = A.Rise.calculate(jdo, observerCoord, A.Mercury);

          // Estrae i Julian Day per ciascun evento
          const riseJD = times.rise;
          const transitJD = times.transit;
          const setJD = times.set;

          // Converte i Julian Day in ore, minuti, secondi (UTC)
          const riseTime = convertJDToTime(riseJD, jdo, timezoneOffset);
          const transitTime = convertJDToTime(transitJD, jdo, timezoneOffset);
          const setTime = convertJDToTime(setJD, jdo, timezoneOffset);

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${day}/${month}/${year}</td>
            <td>${riseTime}</td>
            <td>${transitTime}</td>
            <td>${setTime}</td>
          `;
          tableBody.appendChild(row);
        } catch (error) {
          console.error(`Errore per il giorno ${day}:`, error);
          // Aggiungi una riga con dati vuoti in caso di errore
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${day}/${month}/${year}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          `;
          tableBody.appendChild(row);
        }
      }
    }

    /**
     * Converte un Julian Day in una stringa oraria con l'offset applicato
     */
    function convertJDToTime(jd, baseJD, timezoneOffset) {
      if (jd === null) return '-'; // Nessun evento (es. Sole di mezzanotte)
      
      // Differenza in giorni rispetto al JD base (mezzanotte UTC)
      const diffDays = jd - baseJD.jd;
      // Converte in ore e applica l'offset
      const totalHours = diffDays * 24 + timezoneOffset;
      
      // Formatta in HH:MM:SS
      const hours = Math.floor(totalHours % 24);
      const minutes = Math.floor((totalHours % 1) * 60);
      const seconds = Math.floor(((totalHours % 1) * 60 - minutes) * 60);
      
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // Resto del codice invariato...
  </script>
