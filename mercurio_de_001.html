<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Effemeridi di Mercurio</title>
  <style>
    /* Stili invariati */
  </style>
</head>
<body>
  <div class="container">
    <h1>Effemeridi di Mercurio</h1>
    
    <form id="ephemerisForm">
      <div>
        <label>Mese (1-12):</label>
        <input type="number" id="month" min="1" max="12" value="1" required>
      </div>
      <div>
        <label>Anno:</label>
        <input type="number" id="year" value="2024" required>
      </div>
      <div>
        <label>Latitudine:</label>
        <input type="number" id="latitude" step="any" value="45.4642" required>
      </div>
      <div>
        <label>Longitudine:</label>
        <input type="number" id="longitude" step="any" value="9.1900" required>
      </div>
      <div>
        <button type="button" onclick="calculateEphemeris()">Calcola</button>
      </div>
    </form>

    <table id="resultsTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Levata</th>
          <th>Culminazione</th>
          <th>Tramonto</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Caricamento delle librerie locali -->
  <script src="lib/Astro.JulianDay.js"></script>
  <script src="lib/Astro.Coord.js"></script>
  <script src="lib/Astro.Refraction.js"></script>
  <script src="lib/Astro.Rise.js"></script>
  <script src="lib/Astro.Solar.js"></script>

  <script>
    function calculateEphemeris() {
      console.log("Funzione calculateEphemeris chiamata.");

      // Recupera i valori dal form
      const month = document.getElementById('month').valueAsNumber;
      const year = document.getElementById('year').valueAsNumber;
      const latitude = document.getElementById('latitude').valueAsNumber;
      const longitude = document.getElementById('longitude').valueAsNumber;

      console.log("Input:", { month, year, latitude, longitude });

      // Calcola i giorni del mese
      const daysInMonth = new Date(year, month, 0).getDate();
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';

      console.log("Giorni nel mese:", daysInMonth);

      // Calcola per ogni giorno
      for (let day = 1; day <= daysInMonth; day++) {
        try {
          const date = new Date(Date.UTC(year, month - 1, day, 12));
          const jd = A.JulianDay.fromDate(date).jd;
          const observer = A.GlobeCoord.fromWgs84(latitude, longitude, 0);

          console.log(`Calcolo per il giorno ${day}:`, { date, jd, observer });

          // Verifica se A.Rise.calculate esiste
          if (typeof A.Rise.calculate !== 'function') {
            throw new Error("A.Rise.calculate non è una funzione.");
          }

          // Verifica se A.Solar.mercury esiste
          if (typeof A.Solar.mercury !== 'function') {
            throw new Error("A.Solar.mercury non è una funzione.");
          }

          // Calcola la posizione di Mercurio
          const mercuryPosition = A.Solar.mercury(jd);
          console.log("Posizione di Mercurio:", mercuryPosition);

          // Verifica che la posizione sia valida
          if (!mercuryPosition || typeof mercuryPosition.ra !== 'number' || typeof mercuryPosition.dec !== 'number') {
            throw new Error("Posizione di Mercurio non valida.");
          }

          // Calcola eventi astronomici per Mercurio
          const events = A.Rise.calculate(
            jd,
            observer,
            () => ({ ra: mercuryPosition.ra, dec: mercuryPosition.dec }), // Passa le coordinate
            A.Refraction.atmospheric()
          );

          console.log(`Eventi per il giorno ${day}:`, events);

          // Verifica che gli eventi siano validi
          if (!events || typeof events.rise !== 'number' || typeof events.transit !== 'number' || typeof events.set !== 'number') {
            throw new Error("Eventi non validi.");
          }

          // Formatta la data
          const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;

          // Formatta gli orari
          const formatTime = jd => {
            if (!jd) return '-';
            const d = A.JulianDay.toDate(jd);
            return d.toISOString().substr(11, 8);
          };

          // Crea riga della tabella
          tbody.innerHTML += `
            <tr>
              <td>${formattedDate}</td>
              <td>${formatTime(events.rise)}</td>
              <td>${formatTime(events.transit)}</td>
              <td>${formatTime(events.set)}</td>
            </tr>
          `;
        } catch (e) {
          console.error(`Errore giorno ${day}:`, e);
          tbody.innerHTML += `
            <tr>
              <td>${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}</td>
              <td colspan="3">Errore nel calcolo</td>
            </tr>
          `;
        }
      }
    }
  </script>
</body>
</html>
