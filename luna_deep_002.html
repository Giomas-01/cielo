<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Effemeridi della Luna</title>
  <style>
    /* Stili CSS (rimangono invariati) */
  </style>
</head>
<body>
  <div class="container">
    <h1>Effemeridi della Luna</h1>
    <form id="ephemerisForm">
      <!-- Form (rimane invariato) -->
    </form>

    <!-- Pulsante "Esporta CSV" -->
    <button class="export-button" onclick="exportToCSV()">Esporta CSV</button>

    <table id="resultsTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Levata</th>
          <th>Culminazione</th>
          <th>Tramonto</th>
          <th>Fase Lunare (%)</th>
          <th>Fase</th>
        </tr>
      </thead>
      <tbody>
        <!-- Risultati verranno inseriti qui -->
      </tbody>
    </table>

    <!-- Versione -->
    <p class="version">v1.2</p>
  </div>

  <!-- Includi le librerie necessarie -->
  <script src="lib/suncalc.js"></script>
  <script src="lib/astronomy.js"></script> <!-- Versione browser-friendly -->
  <script src="lib/Astro.js"></script>
  <script src="lib/Astro.Math.js"></script>
  <script src="lib/Astro.DeltaT.js"></script>
  <script src="lib/Astro.JulianDay.js"></script>
  <script src="lib/Astro.Coord.js"></script>
  <script src="lib/Astro.Globe.js"></script>
  <script src="lib/Astro.Interp.js"></script>
  <script src="lib/Astro.Solar.js"></script>
  <script src="lib/Astro.Rise.js"></script>
  <script src="lib/Astro.Refraction.js"></script>
  <script src="lib/Astro.Nutation.js"></script>
  <script src="lib/Astro.Parallax.js"></script>
  <script src="lib/Astro.Moon.js"></script>
  <script src="lib/Astro.MoonIllum.js"></script>
  <script src="lib/Astro.Sidereal.js"></script>
  <script src="lib/Astro.Solistice.js"></script>

  <!-- Script per calcolare le effemeridi della Luna -->
  <script>
    /**
     * Restituisce la fase lunare principale in base al valore della fase (0, 0.25, 0.5, 0.75)
     * @param {number} phase - Valore della fase (0, 0.25, 0.5, 0.75)
     * @returns {string} Fase lunare principale
     */
    function getMainMoonPhase(phase) {
      switch (phase) {
        case 0: return "Luna nuova";
        case 0.25: return "Primo quarto";
        case 0.5: return "Luna piena";
        case 0.75: return "Ultimo quarto";
        default: return "";
      }
    }

    /**
     * Trova la data e l'ora esatta della fase lunare principale per il mese specificato
     * @param {number} year - Anno
     * @param {number} month - Mese
     * @returns {Array} Array di oggetti con la data e l'ora delle fasi lunari principali
     */
    function getMoonPhasesForMonth(year, month) {
      const phases = [];
      const startDate = new Date(Date.UTC(year, month - 1, 1));
      const endDate = new Date(Date.UTC(year, month, 0));

      // Cerca le fasi lunari principali
      const phaseTypes = [0, 0.25, 0.5, 0.75];
      for (const phase of phaseTypes) {
        const phaseTime = Astronomy.SearchMoonPhase(phase, startDate, 30);
        if (phaseTime && phaseTime.date >= startDate && phaseTime.date <= endDate) {
          const phaseName = getMainMoonPhase(phase);
          const phaseTimeStr = phaseTime.date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
          phases.push({ date: phaseTime.date, phase: phaseName, time: phaseTimeStr });
        }
      }

      return phases;
    }

    function calculateEphemeris() {
      const month = parseInt(document.getElementById('month').value);
      const year = parseInt(document.getElementById('year').value);
      const latitude = parseFloat(document.getElementById('latitude').value);
      const longitude = parseFloat(document.getElementById('longitude').value);
      const timezoneOffset = parseInt(document.getElementById('timezone').value); // Offset orario
      const height = 0; // Altezza sopra il livello del mare (può essere modificata)

      const daysInMonth = new Date(year, month, 0).getDate();
      const tableBody = document.querySelector('#resultsTable tbody');
      tableBody.innerHTML = ''; // Pulisce la tabella prima di riempirla

      // Ottieni le fasi lunari principali per il mese specificato
      const moonPhases = getMoonPhasesForMonth(year, month);

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(Date.UTC(year, month - 1, day));
        const jdo = new A.JulianDay(date);
        const coord = A.EclCoord.fromWgs84(latitude, longitude, height);

        // Calcola i tempi di levata, culminazione e tramonto della Luna
        const times = A.Moon.times(jdo, coord);

        // Applica l'offset orario
        const riseTime = addHours(A.Coord.secondsToHMSStr(times.rise), timezoneOffset);
        const transitTime = addHours(A.Coord.secondsToHMSStr(times.transit), timezoneOffset);
        const setTime = addHours(A.Coord.secondsToHMSStr(times.set), timezoneOffset);

        // Calcola la fase lunare e l'illuminazione
        const moonIllumination = SunCalc.getMoonIllumination(date);
        const illuminatedFraction = moonIllumination.fraction;

        // Verifica se questo giorno ha una fase lunare principale
        const phaseInfo = moonPhases.find(phase => 
          phase.date.getUTCDate() === day && phase.date.getUTCMonth() === month - 1
        );
        const phaseTime = phaseInfo ? phaseInfo.time : "";
        const phaseName = phaseInfo ? phaseInfo.phase : "";

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${day}/${month}/${year}</td>
          <td>${riseTime}</td>
          <td>${transitTime}</td>
          <td>${setTime}</td>
          <td>${(illuminatedFraction * 100).toFixed(2)}%</td>
          <td>${phaseTime ? `${phaseTime} ${phaseName}` : ""}</td>
        `;
        tableBody.appendChild(row);
      }
    }

    /**
     * Aggiunge ore a una stringa nel formato HH:MM:SS
     * @param {string} time - Tempo nel formato HH:MM:SS
     * @param {number} hours - Ore da aggiungere (può essere negativo)
     * @returns {string} Tempo aggiornato nel formato HH:MM:SS
     */
    function addHours(time, hours) {
      const [h, m, s] = time.split(':').map(Number);
      let totalSeconds = h * 3600 + m * 60 + s;
      totalSeconds += hours * 3600; // Aggiungi l'offset in secondi

      // Gestisci il caso in cui il tempo superi 24 ore o sia negativo
      totalSeconds = (totalSeconds + 86400) % 86400; // Assicura che sia compreso tra 0 e 86400

      const newH = Math.floor(totalSeconds / 3600) % 24;
      const newM = Math.floor((totalSeconds % 3600) / 60);
      const newS = totalSeconds % 60;

      return `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}:${String(newS).padStart(2, '0')}`;
    }

    /**
     * Esporta i dati della tabella in formato CSV
     */
    function exportToCSV() {
      const rows = document.querySelectorAll('#resultsTable tr');
      let csvContent = "data:text/csv;charset=utf-8,";

      // Aggiungi l'intestazione
      const headers = [];
      document.querySelectorAll('#resultsTable th').forEach(header => {
        headers.push(header.innerText);
      });
      csvContent += headers.join(",") + "\n";

      // Aggiungi i dati
      rows.forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(cell => {
          rowData.push(cell.innerText);
        });
        csvContent += rowData.join(",") + "\n";
      });

      // Crea un link per il download
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "effemeridi_luna.csv");
      document.body.appendChild(link);
      link.click(); // Scarica il file
      document.body.removeChild(link); // Rimuove il link dopo il download
    }
  </script>
</body>
</html>
