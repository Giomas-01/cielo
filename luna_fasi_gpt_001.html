<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Fasi della Luna</title>
    <script type="text/javascript" src="lib/astrojs.js"></script>
</head>
<body>
    <h1>Fasi della Luna</h1>
    <form id="lunarForm">
        <label for="year">Anno:</label>
        <input type="number" id="year" min="1900" max="2100" required>
        
        <label for="utcOffset">UTC Offset:</label>
        <select id="utcOffset">
            <script>
                for (let i = -12; i <= 14; i++) {
                    document.write(`<option value="${i}">${i}</option>`);
                }
            </script>
        </select>
        
        <button type="button" onclick="calculatePhases()">Calcola</button>
    </form>
    
    <table border="1" id="resultTable">
        <thead>
            <tr>
                <th>Data</th>
                <th>Ora (UTC Offset)</th>
                <th>Fase</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    
    <script>
        var emisfero = "N"; // Imposta l'emisfero nord
        
        function calculatePhases() {
            let year = parseInt(document.getElementById("year").value);
            let utcOffset = parseInt(document.getElementById("utcOffset").value);
            let tbody = document.querySelector("#resultTable tbody");
            tbody.innerHTML = "";
            
            let phases = ["Luna Nuova", "Primo Quarto", "Luna Piena", "Ultimo Quarto"];
            let results = [];
            
            if (typeof fasi_lunari !== "function") {
                console.error("Errore: la funzione fasi_lunari() non è definita.");
                alert("Errore: la funzione fasi_lunari() non è disponibile. Verifica il caricamento di astrojs.js.");
                return;
            }
            
            let lunarData = fasi_lunari(year);
            console.log("Dati fasi lunari:", lunarData);
            
            if (!Array.isArray(lunarData) || lunarData.length === 0) {
                console.error("Errore: fasi_lunari() non ha restituito dati validi.");
                alert("Errore nel calcolo delle fasi lunari. Verifica l'anno inserito.");
                return;
            }
            
            for (let i = 0; i < lunarData.length; i++) {
                let dateTime = new Date(lunarData[i]);
                if (isNaN(dateTime)) {
                    console.error("Errore: formato data non valido", lunarData[i]);
                    continue;
                }
                dateTime.setHours(dateTime.getHours() + utcOffset); // Applica l'offset UTC
                
                let formattedDate = dateTime.toISOString().split("T")[0];
                let formattedTime = dateTime.toTimeString().split(" ")[0].substring(0, 5);
                
                results.push({ date: formattedDate, time: formattedTime, phase: phases[i % 4] });
            }
            
            results.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            results.forEach(item => {
                let row = `<tr><td>${item.date}</td><td>${item.time}</td><td>${item.phase}</td></tr>`;
                tbody.innerHTML += row;
            });
        }
    </script>

    <script>
    setTimeout(() => {
        console.log("Funzioni disponibili:", Object.keys(window));
    }, 1000);
    </script>
    
</body>
</html>
